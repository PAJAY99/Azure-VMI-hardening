- name: Download Azure Monitor Agent installer
  command: |
    curl -fsSL -o /tmp/InstallAzureMonitorLinuxAgent.sh https://aka.ms/InstallAzureMonitorLinuxAgent

- name: Verify installer is not HTML
  command: head -n 1 /tmp/InstallAzureMonitorLinuxAgent.sh
  register: script_header

- name: Fail if installer is not a shell script
  fail:
    msg: "Download failed; installer is HTML instead of a shell script."
  when: script_header.stdout is not search("#!")

- name: Make installer executable
  file:
    path: /tmp/InstallAzureMonitorLinuxAgent.sh
    mode: '0755'

- name: Install Azure Monitor Agent
  command: bash /tmp/InstallAzureMonitorLinuxAgent.sh

- name: Configure Azure Monitor Agent with Log Analytics Workspace
  command: >
    /opt/microsoft/azuremonitoragent/bin/azuremonitoragent --configure
    --workspace-id {{ lookup('env', 'WORKSPACE_ID') }}
    --workspace-key {{ lookup('env', 'WORKSPACE_KEY') }}

- name: Verify Azure Monitor Agent is running
  command: systemctl is-active azuremonitoragent
  register: ama_status
  ignore_errors: true

- name: Fail if Azure Monitor Agent service is not running
  fail:
    msg: "Azure Monitor Agent service is not active!"
  when: ama_status.stdout != 'active'